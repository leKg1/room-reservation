# Руководство по тестированию - Система бронирования номеров отеля

## Тестирование бизнес-требований

Это руководство показывает, как тестировать каждое бизнес-требование с помощью **браузера** и **Postman**.

### Предварительные требования
```bash
# Запуск системы
docker-compose up -d

# Добавление тестовых данных
docker-compose exec api yarn seed

# Проверка работы системы
curl http://localhost:3000/rooms
```

---

## 1️⃣ **Клиент может увидеть список номеров в отеле**

### Тестирование через браузер:
- **URL**: http://localhost:3000/rooms
- **Метод**: GET
- **Ожидается**: JSON массив со всеми номерами

### Тестирование через Postman:
```
GET http://localhost:3000/rooms
Headers: Content-Type: application/json
```

### Ожидаемый ответ:
```json
[
  {
    "id": "uuid",
    "number": "101",
    "type": "standard",
    "pricePerNight": "100.00",
    "capacity": 2,
    "description": "Комфортабельный стандартный номер с видом на город",
    "amenities": ["WiFi", "TV", "Кондиционер", "Мини-бар"],
    "isActive": true,
    "createdAt": "2025-06-21T...",
    "updatedAt": "2025-06-21T...",
    "bookings": []
  }
]
```

---

## 2️⃣ **Клиент может увидеть список свободных номеров на определенный период**

### Тестирование через браузер:
- **URL**: http://localhost:3000/rooms/available?checkInDate=2025-07-01&checkOutDate=2025-07-05
- **Метод**: GET
- **Ожидается**: JSON массив только со свободными номерами

### Тестирование через Postman:
```
GET http://localhost:3000/rooms/available
Params:
  checkInDate: 2025-07-01
  checkOutDate: 2025-07-05
Headers: Content-Type: application/json
```

### Тестирование различных сценариев:
1. **Свободный период**: `checkInDate=2025-07-01&checkOutDate=2025-07-05`
2. **Занятый период**: `checkInDate=2025-06-28&checkOutDate=2025-07-02` (должно показать меньше номеров)

---

## 3️⃣ **Клиент может забронировать номер на определенный срок**

### Тестирование через браузер (используя Swagger):
- **URL**: http://localhost:3000/api
- Перейти к `POST /bookings`
- Нажать "Try it out"

### Тестирование через Postman:
```
POST http://localhost:3000/bookings
Headers: Content-Type: application/json
Body (raw JSON):
{
  "roomId": "получить-из-списка-номеров",
  "clientId": "получить-из-списка-клиентов", 
  "checkInDate": "2025-07-01",
  "checkOutDate": "2025-07-05",
  "notes": "Тестовое бронирование"
}
```

### Пошаговая инструкция:
1. **Получить ID номера**: `GET /rooms` → скопировать `id` первого номера
2. **Получить ID клиента**: `GET /clients` → скопировать `id` первого клиента
3. **Создать бронирование**: Использовать ID в POST запросе выше

### Ожидаемый ответ:
```json
{
  "id": "новый-uuid-бронирования",
  "roomId": "uuid-номера",
  "clientId": "uuid-клиента",
  "checkInDate": "2025-07-01T00:00:00.000Z",
  "checkOutDate": "2025-07-05T00:00:00.000Z",
  "totalPrice": 400,
  "status": "active",
  "clientWasVip": true,
  "notes": "Тестовое бронирование"
}
```

---

## 4️⃣ **Клиент может отменить бронь номера**

### Тестирование через браузер (используя Swagger):
- **URL**: http://localhost:3000/api
- Перейти к `PATCH /bookings/{id}/cancel`

### Тестирование через Postman:
```
PATCH http://localhost:3000/bookings/{booking-id}/cancel
Headers: Content-Type: application/json
Body (raw JSON):
{
  "reason": "Планы изменились"
}
```

### Пошаговая инструкция:
1. **Получить ID бронирования**: `GET /bookings` → скопировать `id` бронирования
2. **Отменить бронирование**: Использовать ID в PATCH запросе выше

### Ожидаемый ответ:
```json
{
  "id": "uuid-бронирования",
  "status": "cancelled",
  "notes": "Планы изменились"
}
```

---

## 5️⃣ **VIP статус клиента (запрос удаленного API)**

### Тестирование проверки VIP:

#### Тестирование через браузер:
- **URL**: http://localhost:3000/api
- Перейти к `PATCH /clients/{id}/refresh-vip`

#### Тестирование через Postman:
```
PATCH http://localhost:3000/clients/{client-id}/refresh-vip
Headers: Content-Type: application/json
```

### Пошаговая инструкция:
1. **Получить ID клиента**: `GET /clients` → скопировать `id` клиента
2. **Обновить VIP статус**: Использовать ID в PATCH запросе выше

### Ожидаемый ответ:
```json
{
  "id": "uuid-клиента",
  "firstName": "Иван",
  "lastName": "Иванов",
  "isVip": true,
  "vipCheckDate": "2025-06-21T..."
}
```

### Тестирование VIP в бронировании:
При создании бронирования система автоматически сохраняет VIP статус:
```json
{
  "clientWasVip": true  // ← VIP статус на момент бронирования
}
```

---

## 6️⃣ **Предотвращение двойного бронирования**

### Тестовый сценарий:
1. **Создать первое бронирование** (должно пройти успешно)
2. **Попытаться создать пересекающееся бронирование** (должно завершиться ошибкой)

### Тестирование через Postman:

#### Шаг 1 - Создать первое бронирование:
```
POST http://localhost:3000/bookings
Body:
{
  "roomId": "тот-же-id-номера",
  "clientId": "id-клиента-1",
  "checkInDate": "2025-07-01",
  "checkOutDate": "2025-07-05"
}
```
**Ожидается**: Успех (201 Created)

#### Шаг 2 - Попытаться создать пересекающееся бронирование:
```
POST http://localhost:3000/bookings
Body:
{
  "roomId": "тот-же-id-номера",  // ← Тот же номер!
  "clientId": "id-клиента-2",
  "checkInDate": "2025-07-03",  // ← Пересекается!
  "checkOutDate": "2025-07-07"
}
```
**Ожидается**: Ошибка (400 Bad Request)
```json
{
  "statusCode": 400,
  "message": "Номер недоступен для выбранных дат",
  "error": "Bad Request"
}
```

### Тестирование различных сценариев пересечения:
1. **Полное пересечение**: Те же даты
2. **Пересечение начала**: Новое бронирование начинается до окончания существующего
3. **Пересечение конца**: Новое бронирование заканчивается после начала существующего
4. **Внутреннее пересечение**: Новое бронирование полностью внутри существующего
5. **Внешнее пересечение**: Новое бронирование полностью содержит существующее

---

## **Полный рабочий процесс тестирования**

### 1. Проверка системы:
```bash
curl http://localhost:3000/rooms | jq length
# Должно вернуть: 5
```

### 2. Документация Swagger:
- **URL**: http://localhost:3000/api
- Интерактивное тестирование всех эндпоинтов

### 3. Проверка базы данных:
- **URL**: http://localhost:8080 (Adminer)
- **Вход**: user=`hotel_user`, password=`hotel_password`
- **Сервер**: `postgres`, **База данных**: `hotel_db`

### 4. Полная последовательность тестов:
```bash
# 1. Получить номера
curl http://localhost:3000/rooms

# 2. Получить доступные номера
curl "http://localhost:3000/rooms/available?checkInDate=2025-07-01&checkOutDate=2025-07-05"

# 3. Получить клиентов  
curl http://localhost:3000/clients

# 4. Создать бронирование (использовать реальные ID из шагов 1,3)
curl -X POST http://localhost:3000/bookings \
  -H "Content-Type: application/json" \
  -d '{
    "roomId": "ID_НОМЕРА_ЗДЕСЬ",
    "clientId": "ID_КЛИЕНТА_ЗДЕСЬ", 
    "checkInDate": "2025-07-01",
    "checkOutDate": "2025-07-05"
  }'

# 5. Попытаться двойное бронирование (должно завершиться ошибкой)
curl -X POST http://localhost:3000/bookings \
  -H "Content-Type: application/json" \
  -d '{
    "roomId": "ТОТ_ЖЕ_ID_НОМЕРА",
    "clientId": "ДРУГОЙ_ID_КЛИЕНТА",
    "checkInDate": "2025-07-03", 
    "checkOutDate": "2025-07-07"
  }'

# 6. Отменить бронирование
curl -X PATCH http://localhost:3000/bookings/ID_БРОНИРОВАНИЯ/cancel \
  -H "Content-Type: application/json" \
  -d '{"reason": "Тестовая отмена"}'
```

---

## ✅ **Контрольный список проверки**

- [ ] **Требование 1**: Можно просмотреть все номера → `GET /rooms`
- [ ] **Требование 2**: Можно просмотреть доступные номера → `GET /rooms/available`
- [ ] **Требование 3**: Можно создать бронирование → `POST /bookings`
- [ ] **Требование 4**: Можно отменить бронирование → `PATCH /bookings/{id}/cancel`
- [ ] **Требование 5**: VIP статус проверяется → `PATCH /clients/{id}/refresh-vip`
- [ ] **Требование 6**: Двойное бронирование предотвращается → Пересекающиеся POST запросы завершаются ошибкой

---